var clippy={};clippy.Agent=function(e,d,f){this.path=e,this._queue=new clippy.Queue($.proxy(this._onQueueEmpty,this)),this._el=$('<div class="clippy"></div>').hide(),$(document.body).append(this._el),this._animator=new clippy.Animator(this._el,e,d,f),this._balloon=new clippy.Balloon(this._el),this._setupEvents()},clippy.Agent.prototype={gestureAt:function(h,g){var l=this._getDirection(h,g),k="Gesture"+l,j="Look"+l,i=this.hasAnimation(k)?k:j;return this.play(i)},hide:function(e,d){this._hidden=!0;var f=this._el;this.stop();if(e){this._el.hide(),this.stop(),this.pause(),d&&d();return}return this._playInternal("Hide",function(){f.hide(),this.pause(),d&&d()})},moveTo:function(g,f,j){var i=this._getDirection(g,f),h="Move"+i;j===undefined&&(j=1000),this._addToQueue(function(b){if(j===0){this._el.css({top:f,left:g}),this.reposition(),b();return}if(!this.hasAnimation(h)){this._el.animate({top:f,left:g},j,b);return}var a=$.proxy(function(d,c){c===clippy.Animator.States.EXITED&&b(),c===clippy.Animator.States.WAITING&&this._el.animate({top:f,left:g},j,$.proxy(function(){this._animator.exitAnimation()},this))},this);this._playInternal(h,a)},this)},_playInternal:function(d,c){this._isIdleAnimation()&&this._idleDfd&&this._idleDfd.state()==="pending"&&this._idleDfd.done($.proxy(function(){this._playInternal(d,c)},this)),this._animator.showAnimation(d,c)},play:function(e,d,f){return this.hasAnimation(e)?(d===undefined&&(d=5000),this._addToQueue(function(c){var b=!1,a=function(h,g){g===clippy.Animator.States.EXITED&&(b=!0,f&&f(),c())};d&&window.setTimeout($.proxy(function(){if(b){return}this._animator.exitAnimation()},this),d),this._playInternal(e,a)},this),!0):!1},show:function(e){this._hidden=!1;if(e){this._el.show(),this.resume(),this._onQueueEmpty();return}if(this._el.css("top")==="auto"||!this._el.css("left")==="auto"){var d=$(window).width()*0.8,f=($(window).height()+$(document).scrollTop())*0.8;this._el.css({top:f,left:d})}return this.resume(),this.play("Show")},speak:function(d,c){this._addToQueue(function(a){this._balloon.speak(a,d,c)},this)},closeBalloon:function(){this._balloon.hide()},delay:function(b){b=b||250,this._addToQueue(function(a){this._onQueueEmpty(),window.setTimeout(a,b)})},stopCurrent:function(){this._animator.exitAnimation(),this._balloon.close()},stop:function(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.hide()},hasAnimation:function(b){return this._animator.hasAnimation(b)},animations:function(){return this._animator.animations()},animate:function(){var d=this.animations(),c=d[Math.floor(Math.random()*d.length)];return c.indexOf("Idle")===0?this.animate():this.play(c)},_getDirection:function(t,s){var r=this._el.offset(),q=this._el.height(),p=this._el.width(),o=r.left+p/2,n=r.top+q/2,m=n-s,l=o-t,k=Math.round(180*Math.atan2(m,l)/Math.PI);return -45<=k&&k<45?"Right":45<=k&&k<135?"Up":135<=k&&k<=180||-180<=k&&k<-135?"Left":-135<=k&&k<-45?"Down":"Top"},_onQueueEmpty:function(){if(this._hidden||this._isIdleAnimation()){return}var b=this._getIdleAnimation();this._idleDfd=$.Deferred(),this._animator.showAnimation(b,$.proxy(this._onIdleComplete,this))},_onIdleComplete:function(d,c){c===clippy.Animator.States.EXITED&&this._idleDfd.resolve()},_isIdleAnimation:function(){var b=this._animator.currentAnimationName;return b&&b.indexOf("Idle")===0},_getIdleAnimation:function(){var g=this.animations(),f=[];for(var j=0;j<g.length;j++){var i=g[j];i.indexOf("Idle")===0&&f.push(i)}var h=Math.floor(Math.random()*f.length);return f[h]},_setupEvents:function(){$(window).on("resize",$.proxy(this.reposition,this)),this._el.on("mousedown",$.proxy(this._onMouseDown,this)),this._el.on("dblclick",$.proxy(this._onDoubleClick,this))},_onDoubleClick:function(){this.play("ClickedOn")||this.animate()},reposition:function(){if(!this._el.is(":visible")){return}var t=this._el.offset(),s=this._el.outerHeight(),r=this._el.outerWidth(),q=$(window).width(),p=$(window).height(),o=$(window).scrollTop(),n=$(window).scrollLeft(),m=t.top-o,l=t.left-n,k=5;m-k<0?m=k:m+s+k>p&&(m=p-s-k),l-k<0?l=k:l+r+k>q&&(l=q-r-k),this._el.css({left:l,top:m}),this._balloon.reposition()},_onMouseDown:function(b){b.preventDefault(),this._startDrag(b)},_startDrag:function(b){this.pause(),this._balloon.hide(!0),this._offset=this._calculateClickOffset(b),this._moveHandle=$.proxy(this._dragMove,this),this._upHandle=$.proxy(this._finishDrag,this),$(window).on("mousemove",this._moveHandle),$(window).on("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_calculateClickOffset:function(f){var e=f.pageX,h=f.pageY,g=this._el.offset();return{top:h-g.top,left:e-g.left}},_updateLocation:function(){this._el.css({top:this._targetY,left:this._taregtX}),this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_dragMove:function(e){e.preventDefault();var d=e.clientX-this._offset.left,f=e.clientY-this._offset.top;this._taregtX=d,this._targetY=f},_finishDrag:function(){window.clearTimeout(this._dragUpdateLoop),$(window).off("mousemove",this._moveHandle),$(window).off("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()},_addToQueue:function(d,c){c&&(d=$.proxy(d,c)),this._queue.queue(d)},pause:function(){this._animator.pause(),this._balloon.pause()},resume:function(){this._animator.resume(),this._balloon.resume()}},clippy.Animator=function(i,h,n,m){this._el=i,this._data=n,this._path=h,this._currentFrameIndex=0,this._currentFrame=undefined,this._exiting=!1,this._currentAnimation=undefined,this._endCallback=undefined,this._started=!1,this._sounds={},this.currentAnimationName=undefined,this.preloadSounds(m),this._overlays=[this._el];var l=this._el;this._setupElement(this._el);for(var k=1;k<this._data.overlayCount;k++){var j=this._setupElement($("<div></div>"));l.append(j),this._overlays.push(j),l=j}},clippy.Animator.prototype={_setupElement:function(d){var c=this._data.framesize;return d.css("display","none"),d.css({width:c[0],height:c[1]}),d.css("background","url('"+this._path+"/map.png') no-repeat"),d},animations:function(){var e=[],d=this._data.animations;for(var f in d){e.push(f)}return e},preloadSounds:function(f){for(var e=0;e<this._data.sounds.length;e++){var h=this._data.sounds[e],g=f[h];if(!g){continue}this._sounds[h]=new Audio(g)}},hasAnimation:function(b){return !!this._data.animations[b]},exitAnimation:function(){this._exiting=!0},showAnimation:function(d,c){return this._exiting=!1,this.hasAnimation(d)?(this._currentAnimation=this._data.animations[d],this.currentAnimationName=d,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=undefined,this._endCallback=c,!0):!1},_draw:function(){var f=[];this._currentFrame&&(f=this._currentFrame.images||[]);for(var e=0;e<this._overlays.length;e++){if(e<f.length){var h=f[e],g=-h[0]+"px "+-h[1]+"px";this._overlays[e].css({"background-position":g,display:"block"})}else{this._overlays[e].css("display","none")}}},_getNextAnimationFrame:function(){if(!this._currentAnimation){return undefined}if(!this._currentFrame){return 0}var g=this._currentFrame,f=this._currentFrame.branching;if(this._exiting&&g.exitBranch!==undefined){return g.exitBranch}if(f){var j=Math.random()*100;for(var i=0;i<f.branches.length;i++){var h=f.branches[i];if(j<=h.weight){return h.frameIndex}j-=h.weight}}return this._currentFrameIndex+1},_playSound:function(){var d=this._currentFrame.sound;if(!d){return}var c=this._sounds[d];c&&c.play()},_atLastFrame:function(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1},_step:function(){if(!this._currentAnimation){return}var d=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),c=!this._currentFrame||this._currentFrameIndex!==d;this._currentFrameIndex=d;if(!this._atLastFrame()||!this._currentAnimation.useExitBranching){this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]}this._draw(),this._playSound(),this._loop=window.setTimeout($.proxy(this._step,this),this._currentFrame.duration),this._endCallback&&c&&this._atLastFrame()&&(this._currentAnimation.useExitBranching&&!this._exiting?this._endCallback(this.currentAnimationName,clippy.Animator.States.WAITING):this._endCallback(this.currentAnimationName,clippy.Animator.States.EXITED))},pause:function(){window.clearTimeout(this._loop)},resume:function(){this._step()}},clippy.Animator.States={WAITING:1,EXITED:0},clippy.Balloon=function(b){this._targetEl=b,this._hidden=!0,this._setup()},clippy.Balloon.prototype={WORD_SPEAK_TIME:200,CLOSE_BALLOON_DELAY:2000,_setup:function(){this._balloon=$('<div class="clippy-balloon"><div class="clippy-tip"></div><div class="clippy-content"></div></div> ').hide(),this._content=this._balloon.find(".clippy-content"),$(document.body).append(this._balloon)},reposition:function(){var e=["top-left","top-right","bottom-left","bottom-right"];for(var d=0;d<e.length;d++){var f=e[d];this._position(f);if(!this._isOut()){break}}},_BALLOON_MARGIN:15,_position:function(j){var i=this._targetEl.offset(),p=this._targetEl.height(),o=this._targetEl.width(),n=this._balloon.outerHeight(),m=this._balloon.outerWidth();this._balloon.removeClass("clippy-top-left"),this._balloon.removeClass("clippy-top-right"),this._balloon.removeClass("clippy-bottom-right"),this._balloon.removeClass("clippy-bottom-left");var l,k;switch(j){case"top-left":l=i.left+o-m,k=i.top-n-this._BALLOON_MARGIN;break;case"top-right":l=i.left,k=i.top-n-this._BALLOON_MARGIN;break;case"bottom-right":l=i.left,k=i.top+p+this._BALLOON_MARGIN;break;case"bottom-left":l=i.left+o-m,k=i.top+p+this._BALLOON_MARGIN}this._balloon.css({top:k,left:l}),this._balloon.addClass("clippy-"+j)},_isOut:function(){var t=this._balloon.offset(),s=this._balloon.outerHeight(),r=this._balloon.outerWidth(),q=$(window).width(),p=$(window).height(),o=$(document).scrollTop(),n=$(document).scrollLeft(),m=t.top-o,l=t.left-n,k=5;return m-k<0||l-k<0?!0:m+s+k>p||l+r+k>q?!0:!1},speak:function(f,e,h){this._hidden=!1,this.show();var g=this._content;g.height("auto"),g.width("auto"),g.text(e),g.height(g.height()),g.width(g.width()),g.text(""),this.reposition(),this._complete=f,this._sayWords(e,h,f)},show:function(){if(this._hidden){return}this._balloon.show()},hide:function(b){if(b){this._balloon.hide();return}this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)},_finishHideBalloon:function(){if(this._active){return}this._balloon.hide(),this._hidden=!0,this._hiding=null},_sayWords:function(i,h,n){this._active=!0,this._hold=h;var m=i.split(/[^\S-]/),l=this.WORD_SPEAK_TIME,k=this._content,j=1;this._addWord=$.proxy(function(){if(!this._active){return}j>m.length?(this._active=!1,this._hold||(n(),this.hide())):(k.text(m.slice(0,j).join(" ")),j++,this._loop=window.setTimeout($.proxy(this._addWord,this),l))},this),this._addWord()},close:function(){this._active?this._hold=!1:this._hold&&this._complete()},pause:function(){window.clearTimeout(this._loop),this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)},resume:function(){this._addWord&&this._addWord(),this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)}},clippy.BASE_PATH="//s3.amazonaws.com/clippy.js/Agents/",clippy.load=function(t,s,r){var q=clippy.BASE_PATH+t,p=clippy.load._loadMap(q),o=clippy.load._loadAgent(t,q),n=clippy.load._loadSounds(t,q),m;o.done(function(b){m=b});var l;n.done(function(b){l=b});var k=function(){var b=new clippy.Agent(q,m,l);s(b)};$.when(p,o,n).done(k).fail(r)},clippy.load._maps={},clippy.load._loadMap=function(f){var e=clippy.load._maps[f];if(e){return e}e=clippy.load._maps[f]=$.Deferred();var h=f+"/map.png",g=new Image;return g.onload=e.resolve,g.onerror=e.reject,g.setAttribute("src",h),e.promise()},clippy.load._sounds={},clippy.load._loadSounds=function(i,h){var n=clippy.load._sounds[i];if(n){return n}n=clippy.load._sounds[i]=$.Deferred();var m=document.createElement("audio"),l=!!m.canPlayType&&""!=m.canPlayType("audio/mpeg"),k=!!m.canPlayType&&""!=m.canPlayType('audio/ogg; codecs="vorbis"');if(!l&&!k){n.resolve({})}else{var j=h+(l?"/sounds-mp3.js":"/sounds-ogg.js");clippy.load._loadScript(j)}return n.promise()},clippy.load._data={},clippy.load._loadAgent=function(f,e){var h=clippy.load._data[f];if(h){return h}h=clippy.load._getAgentDfd(f);var g=e+"/agent.js";return clippy.load._loadScript(g),h.promise()},clippy.load._loadScript=function(d){var c=document.createElement("script");c.setAttribute("src",d),c.setAttribute("async","async"),c.setAttribute("type","text/javascript"),document.head.appendChild(c)},clippy.load._getAgentDfd=function(d){var c=clippy.load._data[d];return c||(c=clippy.load._data[d]=$.Deferred()),c},clippy.ready=function(e,d){var f=clippy.load._getAgentDfd(e);f.resolve(d)},clippy.soundsReady=function(e,d){var f=clippy.load._sounds[e];f||(f=clippy.load._sounds[e]=$.Deferred()),f.resolve(d)},clippy.Queue=function(b){this._queue=[],this._onEmptyCallback=b},clippy.Queue.prototype={queue:function(b){this._queue.push(b),this._queue.length===1&&!this._active&&this._progressQueue()},_progressQueue:function(){if(!this._queue.length){this._onEmptyCallback();return}var d=this._queue.shift();this._active=!0;var c=$.proxy(this.next,this);d(c)},clear:function(){this._queue=[]},next:function(){this._active=!1,this._progressQueue()}};