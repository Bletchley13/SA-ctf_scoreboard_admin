require.config({paths:{handsontable:"../app/lookup_editor/js/lib/handsontable.full.min",text:"../app/lookup_editor/js/lib/text",console:"../app/lookup_editor/js/lib/console",csv:"../app/lookup_editor/js/lib/csv",kv_store_field_editor:"../app/lookup_editor/js/views/KVStoreFieldEditor",clippy:"../app/lookup_editor/js/lib/clippy",moment:"../app/lookup_editor/js/lib/moment.min",kvstore:"../app/lookup_editor/js/contrib/kvstore"},shim:{handsontable:{deps:["jquery"],exports:"Handsontable"},clippy:{deps:["jquery"],exports:"clippy"}}});define(["underscore","backbone","models/SplunkDBase","collections/SplunkDsBase","splunkjs/mvc","util/splunkd_utils","jquery","handsontable","splunkjs/mvc/simplesplunkview","splunkjs/mvc/simpleform/input/text","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/simpleform/input/checkboxgroup","text!../app/lookup_editor/js/templates/LookupEdit.html","kv_store_field_editor","moment","kvstore","clippy","csv","bootstrap.dropdown","splunk.util","css!../app/lookup_editor/css/LookupEdit.css","css!../app/lookup_editor/css/lib/handsontable.full.min.css","css!../app/lookup_editor/css/lib/clippy.css"],function(u,a,c,l,k,d,f,m,t,b,g,j,v,q,s,o){var h=l.extend({url:"apps/local?count=-1&search=disabled%3D0",initialize:function(){l.prototype.initialize.apply(this,arguments)}});var e=c.extend({initialize:function(){c.prototype.initialize.apply(this,arguments)}});var p=a.Model.extend();var n=a.Collection.extend({url:Splunk.util.make_full_url("/custom/lookup_editor/lookup_edit/get_lookup_backups_list"),model:p});var r=t.extend({className:"LookupEditView",defaults:{},initialize:function(){this.options=u.extend({},this.defaults,this.options);this.backups=null;this.lookup=null;this.namespace=null;this.owner=null;this.lookup_type=null;this.lookup_config=null;this.field_types={};this.field_types_enforced=false;this.read_only=false;this.table_header=null;this.users=null;this.agent=null;this.kv_store_fields_editor=null;this.forgiving_checkbox_editor=null;this.time_editor=null;this.handsontable=null;this.columns=null;this.apps=new h();this.apps.on("reset",this.gotApps.bind(this),this);this.apps.fetch({success:function(){console.info("Successfully retrieved the list of applications")},error:function(){console.error("Unable to fetch the apps")}});this.is_new=true;this.info_message_posted_time=null;setInterval(this.hideInfoMessageIfNecessary.bind(this),1000);this.listenTo(a,"kv_field:changed",this.validateForm.bind(this))},events:{"click #save":"doSaveLookup","click .backup-version":"doLoadBackup","click .user-context":"doLoadUserContext","click #export-file":"doExport","click #choose-import-file":"chooseImportFile","click #import-file":"openFileImportModal","change #import-file-input":"importFile","dragenter #lookup-table":"onDragFileEnter","dragleave #lookup-table":"onDragFileEnd","click #import-file-modal .btn-dialog-cancel":"cancelImport","click #import-file-modal .btn-dialog-close":"cancelImport","click #refresh":"refreshLookup","click #edit-acl":"editACLs"},hideInfoMessageIfNecessary:function(){if(this.info_message_posted_time&&((this.info_message_posted_time+5000)<new Date().getTime())){this.info_message_posted_time=null;f("#info-message",this.$el).fadeOut(200)}},setupDragDropHandlers:function(){var w=document.getElementById("lookup-table");this.setupDragDropHandlerOnElement(w);drop_zone2=document.getElementById("import-file-modal");this.setupDragDropHandlerOnElement(drop_zone2)},setupDragDropHandlerOnElement:function(w){w.ondragover=function(x){x.preventDefault();x.dataTransfer.dropEffect="copy"}.bind(this);w.ondrop=function(x){x.preventDefault();this.onDropFile(x);return false}.bind(this)},getFieldForColumn:function(w){var x=this.getTableHeader();return x[w]},getTableHeader:function(w){if(typeof w==="undefined"){w=true}if(w&&this.table_header!==null){return this.table_header}if(this.lookup_type==="csv"){this.table_header=this.handsontable.getDataAtRow(0)}else{this.table_header=this.handsontable.getColHeader()}return this.table_header},getColumnForField:function(w){var x=this.getTableHeader();for(var y=0;y<x.length;y++){if(x[y]===w){return y}}console.warn('Unable to find the field with the name "'+w+'"');return null},isCellTypeInvalid:function(z,w,x){if(!this.field_types_enforced){return false}var y=this.getFieldType(w);if(y==="number"&&!/^[-]?\d+$/.test(x)){return true}else{if(y==="boolean"&&!/^(true)|(false)$/.test(x)){return true}}return false},getFieldType:function(x){if(!this.field_types){return null}var w=this.getTableHeader();if(!w){return null}if(x<this.table_header.length){return this.field_types[w[x]]}return null},lookupRenderer:function(w,D,B,x,C,z,y){if(z===null){D.innerHTML=this.escapeHtml("")}else{D.innerHTML=this.escapeHtml(z)}var A=false;if(z){A=(typeof z.toLowerCase==="function")}if(B!==0&&this.isCellTypeInvalid(B,x,z)){D.className="cellInvalidType"}else{if(!z||z===""){D.className="cellEmpty"}else{if(this.getFieldForColumn(x)==="_key"){D.className="cellKey"}else{if(parseFloat(z)<0){D.className="cellNegative"}else{if(String(z).substring(0,7)=="http://"||String(z).substring(0,8)=="https://"){D.className="cellHREF"}else{if(parseFloat(z)>0){D.className="cellPositive"}else{if(B===0&&this.lookup_type==="csv"){D.className="cellHeader"}else{if(z!==null&&A&&z.toLowerCase()==="true"){D.className="cellTrue"}else{if(z!==null&&A&&z.toLowerCase()==="false"){D.className="cellFalse"}else{if(z!==null&&A&&z.toLowerCase()==="unknown"){D.className="cellUrgencyUnknown"}else{if(z!==null&&A&&z.toLowerCase()==="informational"){D.className="cellUrgencyInformational"}else{if(z!==null&&A&&z.toLowerCase()==="low"){D.className="cellUrgencyLow"}else{if(z!==null&&A&&z.toLowerCase()==="medium"){D.className="cellUrgencyMedium"}else{if(z!==null&&A&&z.toLowerCase()==="high"){D.className="cellUrgencyHigh"}else{if(z!==null&&A&&z.toLowerCase()==="critical"){D.className="cellUrgencyCritical"}else{D.className=""}}}}}}}}}}}}}}}if(y.readOnly){D.style.opacity=0.7}},openFileImportModal:function(){f(".dragging").removeClass("dragging");f("#import-in-process",this.$el).hide();f("#import-main",this.$el).show();f("#import-file-modal",this.$el).modal();f(".modal-backdrop").on("dragenter",function(){f(".modal-body").addClass("dragging");console.log("enter")});f(".modal-backdrop").on("dragleave",function(){f(".modal-body").removeClass("dragging");console.log("leave")});f("#import-file-modal").on("dragenter",function(){f(".modal-body").addClass("dragging");console.log("enter")})},chooseImportFile:function(){f("#import-file-input").click()},loadBackupFile:function(w){if(typeof w=="undefined"){w=null}var x=confirm("This version the lookup file will now be loaded.\n\nUnsaved changes will be overridden.");if(x==true){this.loadLookupContents(this.lookup,this.namespace,this.owner,this.lookup_type,false,w);return true}else{return false}},loadUserKVEntries:function(w){if(typeof w=="undefined"){return}this.loadLookupContents(this.lookup,this.namespace,w,this.lookup_type,false);var x={owner:w,namespace:this.namespace,type:this.lookup_type,lookup:this.lookup};history.pushState(x,"Lookup Edit","?"+f.param(x,true))},hideWarningMessage:function(){this.hide(f("#warning-message",this.$el))},hideInfoMessage:function(){this.hide(f("#info-message",this.$el))},hideMessages:function(){this.hideWarningMessage();this.hideInfoMessage()},showWarningMessage:function(w){f("#warning-message > .message",this.$el).text(w);this.unhide(f("#warning-message",this.$el))},showInfoMessage:function(w){f("#info-message > .message",this.$el).text(w);this.unhide(f("#info-message",this.$el));this.info_message_posted_time=new Date().getTime()},loadLookupBackupsList:function(y,x,w){var z={lookup_file:y,namespace:x};if(typeof w==="undefined"){w=null}if(w!==null){z.owner=w}this.backups=new n();this.backups.fetch({data:f.param(z),success:this.renderBackupsList.bind(this)})},onDragFile:function(w){w.stopPropagation();w.preventDefault();w.dataTransfer.dropEffect="copy"},onDragFileEnter:function(w){w.preventDefault();return false},onDragFileEnd:function(){console.log("Dragging stopped");this.$el.removeClass("dragging")},onDropFile:function(w){console.log("Got a file via drag and drop");w.stopPropagation();w.preventDefault();var x=w.dataTransfer.files;this.importFile(w)},escapeHtml:function(w){var x=document.createElement("div");x.appendChild(document.createTextNode(w));return x.innerHTML},cancelImport:function(){this.cancel_import=true},importKVRow:function(y,B,A){if(typeof A==="undefined"){A=jQuery.Deferred()}f("#import-in-process",this.$el).show();f("#import-main",this.$el).hide();f("#import-file-modal .modal-body",this.$el).removeClass("dragging");f("#import-progress",this.$el).css("width",100*(this.import_successes/y.length)+"%");f("#import-error",this.$el).css("width",100*(this.import_errors/y.length)+"%");if(B>=y.length||this.cancel_import){A.resolve();return}var z=y[B];var x={};for(var C=0;C<z.length;C++){if(y[0][C]!=="_key"){x[y[0][C]]=z[C]}}var w=new this.kvStoreModel(x);w.save().done(function(){this.import_successes=this.import_successes+1;this.importKVRow(y,B+1,A)}.bind(this)).error(function(){this.import_errors=this.import_errors+1;this.importKVRow(y,B+1,A)}.bind(this));return A},importKVFile:function(x){var z=jQuery.Deferred();this.cancel_import=false;this.import_errors=0;this.import_successes=0;if(x.length===0){this.showWarningMessage("Unable to import the file since it has no rows");z.reject();return z}for(var y in this.field_types){if(y!=="undefined"){var w=false;for(var A=0;A<x[0].length;A++){if(x[0][A]===y){w=true}}if(!w){this.showWarningMessage("Unable to import the file since the input file is missing the column: "+y);z.reject();return z}}}f("#import-file-modal",this.$el).modal();this.importKVRow(x,1).done(function(){z.resolve();this.refreshLookup();if(this.import_errors>0){this.showWarningMessage("Some rows ("+this.import_errors+") could not be imported; make sure the values are of the correct type")}}.bind(this));return z},importFile:function(x){if(this.read_only){console.info("Drag and dropping on a read-only lookup being ignored");return false}if(!window.FileReader){alert("Your browser doesn't support file reading in Javascript; thus, I cannot parse your uploaded file");return false}var w=new FileReader();w.onload=function(A){console.log("Running file reader onload handler");if(A.target.readyState!=2){return}if(A.target.error){f(".table-loading-message").hide();this.showWarningMessage("Unable to import the file");return}var z=A.target.result;var B=new CSV(z,{}).parse();if(this.lookup_type==="kv"){B=this.importKVFile(B).done(function(){f("#import-file-modal",this.$el).modal("hide")})}else{this.renderLookup(B);f("#import-file-modal",this.$el).modal("hide");this.showInfoMessage("File imported successfully")}}.bind(this);var y=[];if(x.target.files&&x.target.files.length>0){y=x.target.files}else{if(x.dataTransfer&&x.dataTransfer.files.length>0){y=x.dataTransfer.files}}if(y.length>0){if(this.is_new&&(!k.Components.getInstance("lookup-name").val()||k.Components.getInstance("lookup-name").val().length<=0)){k.Components.getInstance("lookup-name").val(y[0].name)}w.readAsText(y[0]);if(this.agent){this.agent.play("Thinking")}}else{f(".table-loading-message").hide()}},renderBackupsList:function(){var w='         		<% for(var c = 0; c < backups.length; c++){ %>         			<li><a class="backup-version" href="#" data-backup-time="<%- backups[c].time %>"><%- backups[c].time_readable %></a></li>         		<% } %>         		<% if(backups.length == 0){ %>         			<li><a class="backup-version" href="#">No backup versions available</a></li>         		<% } %>';f("#backup-versions",this.$el).html(u.template(w,{backups:this.backups.toJSON()}));if(this.read_only!==true){f("#load-backup",this.$el).show()}else{f("#load-backup",this.$el).hide()}},initializeKVStoreModel:function(){this.kvStoreModel=o.Model.extend({collectionName:this.lookup,namespace:{owner:this.owner,app:this.namespace}})},makeKVStoreLookup:function(x,y,w){if(typeof w=="undefined"){w="nobody"}var z={name:y};f.ajax({url:d.fullpath(["/servicesNS",w,x,"storage/collections/config"].join("/")),data:z,type:"POST",success:function(A){console.info("KV store lookup file created");this.lookup=y;this.namespace=x;this.owner=w;this.lookup_type="kv";this.initializeKVStoreModel();this.kv_store_fields_editor.modifyKVStoreLookupSchema(this.namespace,this.lookup,"nobody",function(){this.showInfoMessage("Lookup created successfully");document.location="?lookup="+y+"&owner="+w+"&type=kv&namespace="+x}.bind(this))}.bind(this),complete:function(A,B){if(A.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to make a KV store collection",true)}else{if(A.status==409){console.info("Lookup name already exists");f("#lookup-name-control-group",this.$el).addClass("error");this.showWarningMessage("Lookup name already exists, please select another")}}this.setSaveButtonTitle()}.bind(this),error:function(A,C,B){if(A.status!=403&&A.status!=409){console.info("KV store collection creation failed");this.showWarningMessage("The KV store collection could not be created",true)}}.bind(this)})},loadLookupContents:function(A,z,x,C,y,w){if(typeof y==="undefined"){y=false}var B={lookup_file:A,namespace:z,header_only:y,lookup_type:C};if(typeof w=="undefined"){w=undefined}f(".table-loading-message").show();if(w!==undefined&&w){B.version=w}if(x!==null){B.owner=x}url=Splunk.util.make_full_url("/custom/lookup_editor/lookup_edit/get_lookup_contents",B);var D=new Date().getTime();f.ajax({url:url,cache:false,success:function(F){if(F==null){console.error("JSON of lookup table could not be loaded (got an empty value)");this.showWarningMessage("The requested lookup file could not be loaded",true);f(".show-when-editing",this.$el).hide()}else{if(F.length===0){console.error("JSON of lookup table was successfully loaded (though the file is blank)");this.showWarningMessage("The lookup is blank; edit it to populate it",true);this.renderLookup(this.getDefaultData())}else{console.info("JSON of lookup table was successfully loaded");this.renderLookup(F)}var E=new Date().getTime()-D;console.info("Lookup loaded and rendered in "+E+"ms");this.lookup=A;this.namespace=z;this.owner=x;this.lookup_type=C;this.initializeKVStoreModel();f("#loaded-user-context").text(this.owner)}}.bind(this),complete:function(E,F){if(E.status==404){console.info("Lookup file was not found");this.showWarningMessage("The requested lookup file does not exist",true);f(".show-when-editing",this.$el).hide()}else{if(E.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to view this lookup file",true);f(".show-when-editing",this.$el).hide()}else{if(E.status==420){console.info("File is too large");this.showWarningMessage("The file is too big to be edited (must be less than 10 MB)");f(".show-when-editing",this.$el).hide()}}}f(".table-loading-message").hide();if(w===undefined&&this.lookup_type==="csv"){this.loadLookupBackupsList(A,z,x)}else{if(this.lookup_type==="csv"){this.showInfoMessage("Backup file was loaded successfully")}}}.bind(this),error:function(E,G,F){if(E.status!=404&&E.status!=403&&E.status!=420){console.info("Lookup file could not be loaded");this.showWarningMessage("The lookup could not be loaded from the server",true)}this.read_only=true;this.hideEditingControls()}.bind(this)})},hideEditingControls:function(w){if(typeof w==="undefined"){w=true}if(w){f(".btn",this.$el).hide()}else{f(".btn",this.$el).show()}},validate:function(w){if(w[0][0]===0&&w[0][3].length===0){return false}},validateForm:function(){var x=0;f("#lookup-name-control-group",this.$el).removeClass("error");f("#lookup-app-control-group",this.$el).removeClass("error");this.hideWarningMessage();if(this.is_new&&(!k.Components.getInstance("lookup-name").val()||k.Components.getInstance("lookup-name").val().length<=0)){f("#lookup-name-control-group",this.$el).addClass("error");this.showWarningMessage("Please enter a lookup name");x=x+1}else{if(this.is_new&&!k.Components.getInstance("lookup-name").val().match(/^[-A-Z0-9_ ]+([.][-A-Z0-9_ ]+)*$/gi)){f("#lookup-name-control-group",this.$el).addClass("error");this.showWarningMessage("Lookup name is invalid");x=x+1}}if(this.is_new&&(!k.Components.getInstance("lookup-app").val()||k.Components.getInstance("lookup-app").val().length<=0)){f("#lookup-app-control-group",this.$el).addClass("error");this.showWarningMessage("Select the app where the lookup will reside");x=x+1}if(this.is_new&&this.lookup_type==="kv"){var w=this.kv_store_fields_editor.validate();if(w!==true){this.showWarningMessage(w);x=x+1}}if(x>0){return false}else{return true}},getAppsChoices:function(){if(!this.apps){return[]}var x=[];for(var w=0;w<this.apps.models.length;w++){x.push({label:this.apps.models[w].entry.associated.content.attributes.label,value:this.apps.models[w].entry.attributes.name})}return x},gotApps:function(){if(k.Components.getInstance("lookup-app")){k.Components.getInstance("lookup-app").settings.set("choices",this.getAppsChoices())}},setSaveButtonTitle:function(w){if(typeof w=="undefined"){f("#save").text("Save Lookup")}else{f("#save").text(w)}},pad:function(w,x){var y=w+"";while(y.length<x){y="0"+y}return y},updateTimeModified:function(){var w=new Date();var x=w.getHours()>12?"PM":"AM";f("#modification-time").text("Modified: "+w.getFullYear()+"/"+this.pad(w.getMonth()+1,2)+"/"+w.getDate()+" "+this.pad((w.getHours()%12),2)+":"+this.pad(w.getMinutes(),2)+":"+this.pad(w.getSeconds(),2)+" "+x);f(".modification-time-holder > i").show();f(".modification-time-holder > i").fadeOut(1000)},doLoadBackup:function(x){var w=x.currentTarget.dataset.backupTime;if(w){this.loadBackupFile(w);if(this.agent){this.agent.play("Processing")}}},doLoadUserContext:function(w){var x=w.currentTarget.dataset.user;if(x){this.loadUserKVEntries(x);if(this.agent){this.agent.play("Processing")}}},doExport:function(){var w="../../../custom/lookup_editor/lookup_edit/get_original_lookup_file?namespace="+this.namespace+"&owner="+this.owner+"&lookup_file="+this.lookup+"&type="+this.lookup_type;document.location=w},doSaveLookup:function(w){var y=this.is_new;this.setSaveButtonTitle("Saving...");if(this.agent){this.agent.play("Save")}var z=new Date().getTime();this.hideMessages();if(!this.validateForm()){this.setSaveButtonTitle();return}if(y&&this.lookup_type==="kv"){this.makeKVStoreLookup(k.Components.getInstance("lookup-app").val(),k.Components.getInstance("lookup-name").val())}else{row_data=this.handsontable.getData();json=JSON.stringify(row_data);var x={lookup_file:this.lookup,namespace:this.namespace,contents:json};if(this.owner!==null){x.owner=this.owner}if(y){x.lookup_file=k.Components.getInstance("lookup-name").val();if(x.lookup_file===""){f("#lookup_file_error").text("Please define a file name");f("#lookup_file_error").show();this.setSaveButtonTitle();return false}if(!x.lookup_file.match(/^[-A-Z0-9_ ]+([.][-A-Z0-9_ ]+)*$/gi)){f("#lookup_file_error").text("The file name contains invalid characters");f("#lookup_file_error").show();this.setSaveButtonTitle();return false}x.namespace=k.Components.getInstance("lookup-app").val();if(x.namespace===""){f("#lookup_namespace_error").text("Please define a namespace");f("#lookup_namespace_error").show();this.setSaveButtonTitle();return false}if(f.inArray("user_only",k.Components.getInstance("lookup-user-only").val())>=0){x.owner=Splunk.util.getConfigValue("USERNAME")}}if(row_data.length===0){this.showWarningMessage("Lookup files must contain at least one row (the header)");return false}for(i=0;i<row_data[0].length;i++){if(row_data[0][i]===""){this.showWarningMessage("Header rows cannot contain empty cells (column "+(i+1)+" of the header is empty)");return false}}f.ajax({url:Splunk.util.make_url("/custom/lookup_editor/lookup_edit/save"),type:"POST",data:x,success:function(){console.log("Lookup file saved successfully");this.showInfoMessage("Lookup file saved successfully");this.setSaveButtonTitle();if(this.is_new){this.lookup=x.lookup_file;this.namespace=x.namespace;this.owner=x.owner;this.lookup_type="csv"}}.bind(this),complete:function(B,D){var A=new Date().getTime()-z;console.info("Lookup save operation completed in "+A+"ms");var C=true;if(B.status==404){console.info("Lookup file was not found");this.showWarningMessage("This lookup file could not be found");C=false}else{if(B.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup file");C=false}else{if(B.status==400){console.info("Invalid input");this.showWarningMessage("This lookup file could not be saved because the input is invalid");C=false}else{if(B.status==500){this.showWarningMessage("The lookup file could not be saved");C=false}}}}this.setSaveButtonTitle();if(this.is_new&&C){this.changeToEditMode()}if(C){this.loadLookupBackupsList(this.lookup,this.namespace,this.owner)}}.bind(this),error:function(A,C,B){console.log("Lookup file not saved");this.showWarningMessage("Lookup file could not be saved")}.bind(this)})}return false},doEditCell:function(C,x,y){if(this.read_only){return}var A=this.handsontable.getDataAtRow(C);var z=A[this.getColumnForField("_key")];if(z===undefined){console.error("Unable to get the _key for editing the cell at ("+C+", "+x+")");return}var B=this.makeRowJSON(C);if(z!==null&&z!==undefined&&z.length>0){B._key=z}var w=new this.kvStoreModel(B);w.save({wait:true}).done(function(D){this.hideWarningMessage();if(!z){z=D._key;this.handsontable.setDataAtCell(C,this.getColumnForField("_key"),z,"key_update");console.info("KV store entry creation completed for entry "+z)}else{console.info("KV store entry edit completed for entry "+z)}this.updateTimeModified()}.bind(this)).error(function(F,D,E){if(F!==null&&F.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup",true)}else{if(F!==null&&F.status==400){this.showWarningMessage("Entry could not be saved to the KV store lookup; make sure the value matches the expected type",true)}else{if(E!==null){this.showWarningMessage("Entry could not be saved to the KV store lookup: "+E,true)}else{this.showWarningMessage("Entry could not be saved to the KV store lookup;",true)}}}}.bind(this))},doRemoveRow:function(z){if(this.read_only){return}var y=this.handsontable.getDataAtRow(z);var x=y[0];if(!x&&x.length<0){console.error("Attempt to delete an entry without a valid key");return false}var w=new this.kvStoreModel({_key:x});w.destroy({wait:true}).done(function(){console.info("KV store entry removal completed for entry "+x);this.hideWarningMessage();this.updateTimeModified()}.bind(this)).error(function(A){if(A.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup",true)}else{this.showWarningMessage("An entry could not be removed from the KV store lookup",true)}}.bind(this))},addFieldToJSON:function(x,y,w){var z=[];z=y.split(".");if(z.length>1){if(!(z[0] in x)){x[z[0]]={}}return this.addFieldToJSON(x[z[0]],z.slice(1).join("."),w)}else{x[y]=w;return x}},makeRowJSON:function(A){var z=this.getTableHeader();var w=this.handsontable.getDataAtRow(A);var y={};for(var C=1;C<z.length;C++){var B=this.getFieldType(C);var x=w[C];if(B==="time"){x=new Date(x).valueOf()}if(x===undefined){x=""}this.addFieldToJSON(y,z[C],x)}return y},doCreateRows:function(z,x){if(this.read_only){return}var y=[];for(var A=0;A<x;A++){y.push(this.makeRowJSON(z+A))}var w=new this.kvStoreModel(y);w.save({wait:true}).done(function(B){this.handsontable.setDataAtCell(z,this.getColumnForField("_key"),B._key,"key_update");this.hideWarningMessage();this.updateTimeModified()}.bind(this)).error(function(B){if(B.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup",true)}else{}}.bind(this))},getColumnsMetadata:function(){if(!this.getTableHeader()){console.warn("The table header is not available yet")}var x=this.getTableHeader();var z=null;var y=[];if(!this.field_types){console.warn("The table field types are not available yet")}var w=null;for(var A=0;A<x.length;A++){w=this.field_types[x[A]];z={};if(w==="boolean"){z.type="checkbox";z.editor=this.getCheckboxRenderer()}else{if(w==="time"){z.type="time";z.timeFormat="YYYY/MM/DD HH:mm:ss";z.correctFormat=true;z.renderer=this.timeRenderer.bind(this);z.editor=this.getTimeRenderer()}else{if(w==="number"){z.type="numeric"}}}y.push(z)}return y},reRenderHandsOnTable:function(){if(f("#lookup-table").length>0&&this.handsontable){if(this.handsontable){this.handsontable.render()}}},addEmptyRows:function(w,A,x){var y=[];for(var z=0;z<A;z++){y.push("")}for(z=0;z<x;z++){w.push(f.extend(true,[],y))}},getCheckboxRenderer:function(){if(this.forgiving_checkbox_editor!==null){return this.forgiving_checkbox_editor}this.forgiving_checkbox_editor=m.editors.CheckboxEditor.prototype.extend();this.forgiving_checkbox_editor.prototype.prepare=function(z,x,B,A,w,y){if(w!==true&&w!==false){console.warn("This cell is not a boolean value, it will be populated with 'false', cell=("+z+", "+x+")");this.instance.setDataAtCell(z,x,false)}m.editors.CheckboxEditor.prototype.prepare.apply(this,arguments)};return this.forgiving_checkbox_editor},getTimeRenderer:function(){if(this.time_editor!==null){return this.time_editor}this.time_editor=m.editors.TextEditor.prototype.extend();var w=this.formatTime;this.time_editor.prototype.prepare=function(A,y,C,B,x,z){m.editors.TextEditor.prototype.prepare.apply(this,[A,y,C,B,w(x),z])};return this.time_editor},escapeHtmlRenderer:function(w,C,A,x,B,z,y){C.innerHTML=this.escapeHtml(m.helper.stringify(z));return C},formatTime:function(w){if(/^\d+$/.test(w)){return s(parseInt(w,10)).format("YYYY/MM/DD HH:mm:ss")}else{return w}},timeRenderer:function(w,C,A,x,B,z,y){z=this.escapeHtml(m.helper.stringify(z));C.innerHTML=this.formatTime(z);return C},renderLookup:function(y){if(y===null){this.showWarningMessage("Lookup could not be loaded");return}this.table_header=y[0];if(this.handsontable!==null){this.handsontable.destroy();this.handsontable=null}var w=null;var x=this.read_only;if(this.lookup_type==="kv"){w={items:{row_above:{disabled:function(){return this.read_only||(this.handsontable.getSelected()===undefined)}.bind(this)},row_below:{disabled:function(){return this.read_only}.bind(this)},hsep1:"---------",remove_row:{disabled:function(){return this.read_only||(this.handsontable.getSelected()===undefined)}.bind(this)},hsep2:"---------",undo:{disabled:function(){return this.read_only}.bind(this)},redo:{disabled:function(){return this.read_only}.bind(this)}}}}else{w={items:{row_above:{disabled:function(){return this.read_only||(this.handsontable.getSelected()!==undefined&&this.handsontable.getSelected()[0]===0)}.bind(this)},row_below:{disabled:function(){return this.read_only}.bind(this)},hsep1:"---------",col_left:{disabled:function(){return this.read_only}.bind(this)},col_right:{disabled:function(){return this.read_only}.bind(this)},hsep2:"---------",remove_row:{disabled:function(){return this.read_only}.bind(this)},remove_col:{disabled:function(){return this.read_only}.bind(this)},hsep3:"---------",undo:{disabled:function(){return this.read_only}.bind(this)},redo:{disabled:function(){return this.read_only}.bind(this)}}}}if(this.lookup_type==="kv"){f("#lookup-table").addClass("kv-lookup");this.columns=this.getColumnsMetadata()}else{f("#lookup-table").addClass("csv-lookup")}if(y.length===1){this.addEmptyRows(y,y[0].length,5)}self=this;this.handsontable=new m(f("#lookup-table")[0],{data:this.lookup_type==="kv"?y.slice(1):y,startRows:1,startCols:1,contextMenu:w,minSpareRows:0,minSpareCols:0,colHeaders:this.lookup_type==="kv"?this.table_header:false,columns:this.columns,rowHeaders:true,fixedRowsTop:this.lookup_type==="kv"?0:1,height:function(){return f(window).height()-320},stretchH:"all",manualColumnResize:true,manualColumnMove:true,onBeforeChange:this.validate.bind(this),allowInsertColumn:this.lookup_type==="kv"?false:true,allowRemoveColumn:this.lookup_type==="kv"?false:true,renderer:this.lookupRenderer.bind(this),cells:function(B,z,C){var A={};if(this.read_only||(this.lookup_type==="kv"&&z==0)){A.readOnly=true}return A}.bind(this),beforeRemoveRow:function(A,B){if((this.countRows()-B)<=0&&self.lookup_type!=="kv"){alert("A valid lookup file requires at least one row (for the header).");return false}if(A==0&&self.lookup_type!=="kv"){var z=confirm("Are you sure you want to delete the header row?\n\nNote that a valid lookup file needs at least a header.");if(!z){return false}}},beforeRemoveCol:function(z,A){if((this.countCols()-A)<=0){alert("A valid lookup file requires at least one column.");return false}},afterRemoveCol:function(z,A){if(this.countCols()==0){alert("You must have at least one cell to have a valid lookup")}},afterRemoveRow:function(z,A){if(this.countRows()==0){self.loadLookupContents(self.lookup,self.namespace,self.owner,self.lookup_type,false)}},afterColumnMove:function(){this.getTableHeader(false)}.bind(this)});if(this.lookup_type==="kv"){this.handsontable.addHook("afterChange",function(B,C){if(C==="key_update"){return}if(!B){return}for(var E=0;E<B.length;E++){var D=B[E][0];var z=B[E][1];var A=B[E][3];this.doEditCell(D,z,A)}}.bind(this));this.handsontable.addHook("beforeRemoveRow",function(z,A){for(var C=0;C<A;C++){var B=z+C;this.doRemoveRow(B)}}.bind(this));this.handsontable.addHook("afterCreateRow",this.doCreateRows.bind(this))}},hide:function(w){w.css("display","none");w.addClass("hide")},unhide:function(w){w.removeClass("hide");w.removeAttr("style")},changeToEditMode:function(){f("#lookup-name-static",this.$el).text(this.lookup);this.unhide(f("#lookup-name-static",this.$el));this.hide(f(".show-when-creating",this.$el));f("h2",this.$el).text("Edit Lookup");this.is_new=false;var w="?lookup="+this.lookup+"&namespace="+this.namespace+"&type="+this.lookup_type;if(this.owner){w+="&owner="+this.owner}else{w+="&owner=nobody"}history.pushState(null,"Lookup Edit",w)},handleShortcuts:function(w){if(w.keyCode==69&&w.ctrlKey){this.toggleClippy()}},toggleClippy:function(){if(this.agent===null){clippy.load("Clippy",function(w){this.agent=w;this.agent.show()}.bind(this))}else{if(f(".clippy").length==0||!f(".clippy").is(":visible")){this.agent.show()}else{if(f(".clippy").length>0&&f(".clippy").is(":visible")){this.agent.hide()}}}},getUsers:function(w){var y=jQuery.Deferred();var x=Splunk.util.make_url("/splunkd/__raw/services/admin/users?output_mode=json");jQuery.ajax({url:x,type:"GET",async:false,success:function(z){y.resolve(this.makeUsersList(w,z.entry))}.bind(this),error:function(){y.resolve(this.makeUsersList(w))}.bind(this)});return y},renderUserList:function(x){var w='<% for(var c = 0; c < users.length; c++){ %> 									<li> 										<a class="user-context" href="#" data-user="<%- users[c].name %>"> 										<%- users[c].readable_name %> 										<% if(users[c].description){ %> 											(<%- users[c].description %>) 										<% } %> 										</a> 									</li> 								<% } %>';f("#load-user-context > ul",this.$el).html(u.template(w,{users:x}))},makeUsersList:function(w,z){if(typeof z=="undefined"){z=[]}var D=[];var y=null;for(var C=0;C<z.length;C++){y=z[C];var A="";if(y.name===w){A="owner of the lookup"}if(y.name==="nobody"){A="entries visible from search"}D.push({name:y.name,readable_name:y.content.realname.length>0?y.content.realname:y.name,description:A})}if(z.length===0){if(w){D.push({name:w,readable_name:w,description:"owner of the lookup"})}D.push({name:Splunk.util.getConfigValue("USERNAME"),readable_name:Splunk.util.getConfigValue("USERNAME"),description:""})}D.push({name:"nobody",readable_name:"nobody",description:"entries visible from search"});D=u.uniq(D,function(G,F,E){return G.name});var x=["nobody",w,Splunk.util.getConfigValue("USERNAME")];function B(F,E){var H=F.name.toLowerCase();var G=E.name.toLowerCase();for(var I=0;I<x.length;I++){if(F.name==x[I]){return -1}if(E.name==x[I]){return 1}}if(H<G){return -1}if(H>G){return 1}return 0}D.sort(B);return D},getDefaultData:function(){return[["Column1","Column2","Column3","Column4","Column5","Column6"],["","","","","",""],["","","","","",""],["","","","","",""],["","","","","",""]]},changeCollectionACL:function(w,C,B,x,A,y){if(A.isArray()){A=A.join(",")}if(y.isArray()){y=y.join(",")}var z={output_mode:"json","perms.read":"*","perms.write":"*",sharing:x,owner:w};f.ajax({url:d.fullpath("/servicesNS/"+w+"/"+C+"/storage/collections/config/"+B+"/acl"),data:z,type:"POST",success:function(D){console.info("ACL successfully updated")}})},editACLs:function(){if(this.lookup_type=="kv"){var w="/servicesNS/nobody/"+this.namespace+"/storage/collections/config/"+this.lookup;document.location="/en-US/manager/permissions/"+this.namespace+"/storage/collections/config/"+this.lookup+"?uri="+encodeURIComponent(w)}else{var w="/servicesNS/"+this.owner+"/"+this.namespace+"/data/lookup-table-files/"+this.lookup;document.location="/en-US/manager/permissions/"+this.namespace+"/data/lookup-table-files/"+this.lookup+"?uri="+encodeURIComponent(w)}},refreshLookup:function(){this.render()},render:function(){console.log("Rendering...");this.lookup=Splunk.util.getParameter("lookup");this.namespace=Splunk.util.getParameter("namespace");this.owner=Splunk.util.getParameter("owner");this.lookup_type=Splunk.util.getParameter("type");this.is_new=false;if((this.lookup===null&&this.namespace===null&&this.owner===null)||(Splunk.util.getParameter("action")==="new")){this.is_new=true}var z=this.makeUsersList(this.owner);this.$el.html(u.template(v,{insufficient_permissions:false,is_new:this.is_new,lookup_name:this.lookup,lookup_type:this.lookup_type,users:z}));f(document).keydown(this.handleShortcuts.bind(this));console.info("Press CTRL + E to see something interesting");if(this.is_new){var w=new b({id:"lookup-name",searchWhenChanged:false,el:f("#lookup-name",this.$el)},{tokens:true}).render();w.on("change",function(A){this.validateForm()}.bind(this));var x=new g({id:"lookup-app",selectFirstChoice:false,showClearButton:false,el:f("#lookup-app",this.$el),choices:this.getAppsChoices()},{tokens:true}).render();x.on("change",function(A){this.validateForm()}.bind(this));var y=new j({id:"lookup-user-only",choices:[{label:"User-only",value:"user_only"}],el:f("#lookup-user-only")},{tokens:true}).render();y.on("change",function(A){this.validateForm()}.bind(this))}this.setupDragDropHandlers();if(this.lookup_type==="kv"&&!this.is_new){this.lookup_config=new e();this.lookup_config.fetch({url:d.fullpath(["/servicesNS","nobody",this.namespace,"storage/collections/config",this.lookup].join("/")),success:function(D,B,C){console.info("Successfully retrieved the information about the KV store lookup");for(var A in D.entry.associated.content.attributes){if(A.indexOf("field.")===0){this.field_types[A.substr(6)]=D.entry.associated.content.attributes[A]}}if(D.entry.associated.content.attributes.hasOwnProperty("enforceTypes")){if(D.entry.associated.content.attributes.enforceTypes==="true"){this.field_types_enforced=true}else{this.field_types_enforced=false}}if(!D.entry.acl.attributes.can_write){this.read_only=true;this.showWarningMessage("You do not have permission to edit this lookup; it is being displayed read-only")}}.bind(this),error:function(){console.warn("Unable to retrieve the information about the KV store lookup")}.bind(this),complete:function(){this.loadLookupContents(this.lookup,this.namespace,this.owner,this.lookup_type)}.bind(this)})}else{if(this.lookup_type==="kv"&&this.is_new){this.kv_store_fields_editor=new q({el:f("#lookup-kv-store-edit",this.$el)});this.kv_store_fields_editor.render();f("#lookup-kv-store-edit",this.$el).show();f("#save",this.$el).show();f("#lookup-table",this.$el).hide()}else{if(this.is_new){this.renderLookup(this.getDefaultData())}else{if(this.lookup==null||this.namespace==null||this.owner==null){this.showWarningMessage("Not enough information to identify the lookup file to load")}else{this.loadLookupContents(this.lookup,this.namespace,this.owner,this.lookup_type)}}}}f.when(this.getUsers(this.owner)).done(function(A){console.info("Rendering users list");this.renderUserList(A)}.bind(this))}});return r});