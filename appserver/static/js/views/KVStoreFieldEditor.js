require.config({paths:{text:"../app/lookup_editor/js/lib/text",console:"../app/lookup_editor/js/lib/console",kv_store_field_view:"../app/lookup_editor/js/views/KVStoreFieldView"}});define(["underscore","backbone","splunkjs/mvc","util/splunkd_utils","jquery","splunkjs/mvc/simplesplunkview","kv_store_field_view","text!../app/lookup_editor/js/templates/KVStoreFieldEditor.html","css!../app/lookup_editor/css/KVStoreFieldEditor.css"],function(i,h,a,b,c,f,e,d){var g=f.extend({className:"KVStoreFieldEditor",defaults:{default_field_count:5},events:{"click .add-additional-field":"doAddField"},initialize:function(){this.options=i.extend({},this.defaults,this.options);this.field_views=[];this.field_counter=0;this.default_field_count=this.options.default_field_count;this.listenTo(h,"kv_field:remove",this.removeField.bind(this))},validate:function(){var j=false;for(var n=0;n<this.field_views.length;n++){if(this.field_views[n].hasFieldName()){j=true}this.field_views[n].hideErrorMessage()}if(!j){return"At least one field needs to be defined"}var k=[];var r=null;var o=null;for(n=0;n<this.field_views.length;n++){if(this.field_views[n].hasFieldName()){r=this.field_views[n].getFieldName().split(".").slice(0,-1);o=null;for(var m=0;m<r.length;m++){if(o===null){o=r[m]}else{o=o+"."+r[m]}k.push(o)}}}var p=false;for(n=0;n<this.field_views.length;n++){for(var m=0;m<k.length;m++){if(k[m]===this.field_views[n].getFieldName()){this.field_views[n].showErrorMessage("This field's name cannot co-exist with another field that has '"+k[m]+'" in its name');p=true;return'The field "'+this.field_views[n].getFieldName()+'" cannot be used'}}}var l=false;for(n=0;n<this.field_views.length;n++){for(var m=0;m<this.field_views.length;m++){if(n!==m&&this.field_views[n].hasFieldName()){if(this.field_views[n].getFieldName()===this.field_views[m].getFieldName()){this.field_views[n].showErrorMessage("Another field has this name already");this.field_views[m].showErrorMessage("Another field has this name already");l=true}}}}if(l){return"Fields cannot have the same name"}var q=false;for(n=0;n<this.field_views.length;n++){if(this.field_views[n].getFieldName().indexOf("$")>-1){this.field_views[n].showErrorMessage("The name cannot contain a $");q=true}}if(q){return"Field names cannot contain $ characters"}return true},removeField:function(j){this.field_views=i.without(this.field_views,i.findWhere(this.field_views,{unique_identifier:j}))},doAddField:function(){this.addFieldView("","string")},addFieldView:function(l,m){var k="kv_store_field_"+this.field_counter;c('<div id="'+k+'"></div>').appendTo("#kv-store-fields");var j=new e({el:c("#"+k,this.$el),unique_identifier:k});this.field_views.push(j);j.render();this.field_counter++},modifyKVStoreLookupSchema:function(k,l,j,o){if(typeof j=="undefined"){j="nobody"}if(typeof o=="undefined"){o=null}var m={};for(var n=0;n<this.field_views.length;n++){if(this.field_views[n].hasFieldName()){m["field."+this.field_views[n].getFieldName()]=this.field_views[n].getFieldType()}}m.replicate="true";c.ajax({url:b.fullpath(["/servicesNS",j,k,"storage/collections/config",l].join("/")),data:m,type:"POST",success:function(p){console.info("KV store lookup file created");this.lookup=l;this.namespace=k;this.owner=j;this.lookup_type="kv";if(o){o()}}.bind(this),complete:function(p,q){if(p.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to make a KV store collection",true)}}.bind(this),error:function(p,r,q){if(p.status!=403){console.info("KV store collection creation failed");this.showWarningMessage("The KV store collection could not be created",true)}}.bind(this)})},render:function(){this.$el.html(i.template(d,{}));var j={};for(var k in j){this.addFieldView(k,j[k])}if(this.field_views.length===0){for(var l=0;l<this.default_field_count;l++){this.addFieldView("","string")}}}});return g});